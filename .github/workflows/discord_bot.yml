name: Evoars Colorize Bot

on:
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø¶ØºØ·Ø© Ø²Ø±

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1 libglib2.0-0

      - name: Install Python requirements
        working-directory: ./Evoars_local/Evoars-main
        run: |
          pip install -r requirements.txt
          pip install "numpy<2.0.0" "opencv-python-headless==4.6.0.66"

      - name: Start Server & Tunnel
        working-directory: ./Evoars_local/Evoars-main
        run: |
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          echo "Starting App..."
          nohup python app.py > app.log 2>&1 &
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±
          sleep 10
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù„Ù…Ù„Ù
          echo "Starting SSH Tunnel..."
          nohup ssh -o StrictHostKeyChecking=no -R 80:127.0.0.1:7860 nokey@localhost.run > tunnel.log 2>&1 &
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©
          echo "Waiting for URL..."
          TUNNEL_URL=""
          for i in {1..30}; do
            if grep -q "lhr.life" tunnel.log; then
              TUNNEL_URL=$(grep -o 'https://[^ ]*\.lhr\.life' tunnel.log | head -n 1)
              echo "URL Found: $TUNNEL_URL"
              break
            fi
            sleep 2
          done
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Failed to get tunnel URL"
            cat tunnel.log
            exit 1
          fi
          
          # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Discord
          echo "Sending to Discord..."
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ğŸš€ **Evoars Bot Started!**\nğŸ”— Tunnel Link: $TUNNEL_URL\nâœ… The server is running and ready for processing.\"}" \
               "https://discord.com/api/webhooks/1463233978051072049/WYKPPFwYliuCQNLNd-9LHeCfQAKThaHbsF4LO6jQZsaEwpIVaZI4JJ_0alQzIaL2luXs"
          
          # Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù„ØªØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· (Active Monitoring)
          echo "Entering monitoring mode..."
          LAST_SENT_URL="$TUNNEL_URL"
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            # ØªÙˆÙ‚Ù Ø¨Ø¹Ø¯ 6 Ø³Ø§Ø¹Ø§Øª (21600 Ø«Ø§Ù†ÙŠØ©)
            if [ $ELAPSED -ge 21600 ]; then
              echo "Time limit reached. Exiting."
              break
            fi
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø­Ø¯Ø« Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…Ù„Ù
            NEW_URL=$(grep -o 'https://[^ ]*\.lhr\.life' tunnel.log | tail -n 1)
            
            if [ ! -z "$NEW_URL" ] && [ "$NEW_URL" != "$LAST_SENT_URL" ]; then
              echo "âš ï¸ URL Changed! New: $NEW_URL"
              curl -H "Content-Type: application/json" \
                   -d "{\"content\": \"ğŸ”„ **Tunnel Reconnected!**\nğŸ†• New Link: $NEW_URL\"}" \
                   "https://discord.com/api/webhooks/1463233978051072049/WYKPPFwYliuCQNLNd-9LHeCfQAKThaHbsF4LO6jQZsaEwpIVaZI4JJ_0alQzIaL2luXs"
              LAST_SENT_URL="$NEW_URL"
            fi
            
            sleep 10
          done
