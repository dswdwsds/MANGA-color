name: Evoars Colorize Bot

on:
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ø¶ØºØ·Ø© Ø²Ø±

jobs:
  run-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1 libglib2.0-0

      - name: Install Python requirements
        working-directory: ./Evoars_local/Evoars-main
        run: |
          pip install -r requirements.txt
          pip install "numpy<2.0.0" "opencv-python-headless==4.6.0.66"

      - name: Start Server & Tunnel
        working-directory: ./Evoars_local/Evoars-main
        run: |
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          echo "Starting App..."
          nohup python app.py > app.log 2>&1 &
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±
          sleep 10
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙˆØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ù„Ù…Ù„Ù
          echo "Starting SSH Tunnel..."
          nohup ssh -o StrictHostKeyChecking=no -R 80:127.0.0.1:7860 nokey@localhost.run > tunnel.log 2>&1 &
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©
          echo "Waiting for URL..."
          TUNNEL_URL=""
          for i in {1..30}; do
            if grep -q "lhr.life" tunnel.log; then
              TUNNEL_URL=$(grep -o 'https://[^ ]*\.lhr\.life' tunnel.log | head -n 1)
              echo "URL Found: $TUNNEL_URL"
              break
            fi
            sleep 2
          done
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Failed to get tunnel URL"
            cat tunnel.log
            exit 1
          fi
          
          # Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Discord
          send_discord_msg() {
            local content=$1
            curl -H "Content-Type: application/json" \
                 -d "{\"content\": \"$content\"}" \
                 "https://discord.com/api/webhooks/1463233978051072049/WYKPPFwYliuCQNLNd-9LHeCfQAKThaHbsF4LO6jQZsaEwpIVaZI4JJ_0alQzIaL2luXs"
          }

          # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø¡
          send_discord_msg "ğŸš€ **Evoars Bot Started!**\nğŸ”— Tunnel Link: $TUNNEL_URL\nâœ… Server is running. Time limit: 6 hours."
          
          # Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© (Active Monitoring)
          echo "Entering monitoring mode..."
          LAST_SENT_URL="$TUNNEL_URL"
          START_TIME=$(date +%s)
          MAX_DURATION=$((6 * 3600))
          LAST_STATUS_TIME=0
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((MAX_DURATION - ELAPSED))
            
            # Ù…Ù†Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ù„Ø¨Ø© Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            if [ $REMAINING -lt 0 ]; then REMAINING=0; fi
            
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            REM_H=$((REMAINING / 3600))
            REM_M=$(( (REMAINING % 3600) / 60 ))
            
            # Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
            STATS_JSON=$(curl -s --max-time 2 http://127.0.0.1:7860/stats || echo "{}")
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… grep/sed Ø¨Ø¨Ø³Ø§Ø·Ø© Ù„Ø¹Ø¯Ù… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ jq Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø«Ø¨ØªÙ‹Ø§
            CPU_USAGE=$(echo "$STATS_JSON" | grep -o '"cpu_percent":[^,}]*' | cut -d: -f2 | tr -d ' ')
            RAM_USAGE=$(echo "$STATS_JSON" | grep -o '"ram_percent":[^,}]*' | cut -d: -f2 | tr -d ' ')
            ACTIVE_USERS=$(echo "$STATS_JSON" | grep -o '"active_users":[^,}]*' | cut -d: -f2 | tr -d ' ')
            
            if [ -z "$CPU_USAGE" ]; then CPU_USAGE="N/A"; fi
            if [ -z "$RAM_USAGE" ]; then RAM_USAGE="N/A"; fi
            if [ -z "$ACTIVE_USERS" ]; then ACTIVE_USERS="0"; fi

            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø­Ø¯Ø« Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…Ù„Ù
            NEW_URL=$(grep -o 'https://[^ ]*\.lhr\.life' tunnel.log | tail -n 1)
            
            # Ø§Ù„Ø­Ø§Ù„Ø© 1: ØªØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø·
            if [ ! -z "$NEW_URL" ] && [ "$NEW_URL" != "$LAST_SENT_URL" ]; then
              echo "âš ï¸ URL Changed! New: $NEW_URL"
              send_discord_msg "ğŸ”„ **Tunnel Reconnected!**\nğŸ†• New Link: $NEW_URL\nğŸ“Š Stats: CPU ${CPU_USAGE}% | RAM ${RAM_USAGE}% | Users: ${ACTIVE_USERS}\nâ³ Time Remaining: ${REM_H}h ${REM_M}m"
              LAST_SENT_URL="$NEW_URL"
            fi
            
            # Ø§Ù„Ø­Ø§Ù„Ø© 2: ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø© (1800 Ø«Ø§Ù†ÙŠØ©)
            if [ $((CURRENT_TIME - LAST_STATUS_TIME)) -ge 1800 ]; then
               send_discord_msg "â„¹ï¸ **Status Update**\nğŸ”— Link: $LAST_SENT_URL\nğŸ“Š Stats: CPU ${CPU_USAGE}% | RAM ${RAM_USAGE}% | Users: ${ACTIVE_USERS}\nâ³ Time Remaining: ${REM_H}h ${REM_M}m"
               LAST_STATUS_TIME=$CURRENT_TIME
            fi
            
            # Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª (ØªØ¬Ø§ÙˆØ² 6 Ø³Ø§Ø¹Ø§Øª)ØŒ GitHub Actions Ø³ÙŠÙ‚ØªÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ù†Ø±Ø³Ù„ ØªØ­Ø°ÙŠØ± Ù‚Ø¨Ù„Ù‡Ø§
            if [ $REMAINING -le 300 ] && [ $REMAINING -gt 290 ]; then
               send_discord_msg "âš ï¸ **Warning: 5 Minutes Remaining!**\nServer will stop soon. Please trigger the workflow again if needed."
            fi
            
            sleep 10
          done
